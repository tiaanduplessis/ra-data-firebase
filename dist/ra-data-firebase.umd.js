!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("firebase"),require("sort-by"),require("react-admin"),require("deep-assign")):"function"==typeof define&&define.amd?define(["exports","firebase","sort-by","react-admin","deep-assign"],t):t(e.raDataFirebase={},e.firebase,null,null,null)}(this,function(e,t,r,n,a){t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a;var i={upload:function(e,r,n,a,i){return new Promise(function(a,u){var o,c,d,s;return o=r[e]&&Array.isArray(r[e])?r[e][0]:r[e],c={},o&&o.rawFile&&o.rawFile.name?(d=o.rawFile,t.storage().ref().child(i+"/"+n+"/"+e).put(d).then(function(t){try{if(s=t,c[e]=[{}],c[e][0].uploadedAt=Date.now(),c[e][0].src=s.downloadURL.split("?").shift()+"?alt=media",c[e][0].type=d.type,0===d.type.indexOf("image/")){var r=function(){try{return f.call(this)}catch(e){return u(e)}}.bind(this),n=function(e){try{return console.error("Failed to get image dimensions"),r()}catch(e){return u(e)}};try{var i;return function(e){return new Promise(function(t){var r=document.createElement("img");r.onload=function(){t({width:this.width,height:this.height})},r.src=e.src})}(o).then(function(t){try{return c[e][0].width=(i=t).width,c[e][0].height=i.height,r()}catch(e){return n()}},n)}catch(e){n()}}function f(){return a(c)}return f.call(this)}catch(e){return u(e)}}.bind(this),u)):a(!1)})},save:function(e,r,n,a,i,u,o,c,d){return new Promise(function(a,s){var f,l,h,y;return y=t.auth().currentUser,o&&o.map(function(e){return!!e&&Object.assign(r,e)}),c&&Object.assign(r,((f={})[d.createdAt]=Date.now(),f)),y&&Object.assign(r,((l={})[d.createdBy]=y.uid,l)),(r=Object.assign(n,((h={})[d.updatedAt]=Date.now(),h),r)).key||(r.key=e),r.id||(r.id=e),t.database().ref(i+"/"+r.key).update(u(r)).then(function(e){try{return a({data:r})}catch(e){return s(e)}},s)})},del:function(e,r,n,a){return new Promise(function(r,i){return a.length&&a.map(function(r){return t.storage().ref().child(n+"/"+e+"/"+r).delete()}),t.database().ref(n+"/"+e).remove().then(function(t){try{return r({data:e})}catch(e){return i(e)}},i)})},getItemID:function(e,r,a,i,u){var o=e.data.id||e.id||e.data.key||e.key;if(o||(o=t.database().ref().child(i).push().key),!o)throw new Error("ID is required");if(u&&u[o]&&r===n.CREATE)throw new Error("ID already in use");return o},getOne:function(e,t,r){if(e.id&&r[e.id])return{data:r[e.id]};throw new Error("Key not found")},getMany:function(e,t,n){var a=[],i=[],u=0;if(e.ids&&Array.isArray(e.ids))return e.ids.forEach(function(e){n[e]&&(a.push(e),i.push(n[e]),u++)}),{total:u,ids:a,data:i};if(e.pagination){var o=[],c=Object.assign({},e.filter);e.target&&e.id&&(c[e.target]=e.id);var d=Object.keys(c);d.length?Object.values(n).map(function(e){for(var t=0;t<d.length;){var r=d[t];if("q"!==r&&e[r]!==c[r])return t;if("q"===r&&-1===JSON.stringify(e).indexOf(c.q))return t;t++}return o.push(e),t}):o=Object.values(n),e.sort&&o.sort(r(("ASC"===e.sort.order?"-":"")+e.sort.field));var s=o.map(function(e){return e.id}),f=e.pagination,l=f.page,h=f.perPage,y=(l-1)*h,m=l*h;return i=o.slice(y,m),a=s.slice(y,m),{data:i,ids:a,total:u=o.length}}throw new Error("Error processing request")}},u={initialQuerytimeout:1e4,metaFieldNames:{createdAt:"createdAt",updatedAt:"updatedAt",createdBy:"createdBy"},admin:{path:"users",config:{},validate:function(){return!0}},debug:!1,trackedResources:[],firebaseSaveFilter:function(e){return e},firebaseGetFilter:function(e){return e}};e.FirebaseDataProvider=function(e){void 0===e&&(e={});var r=(e=a({},u,i,e)).metaFieldNames,o=e.trackedResources,c=e.initialQuerytimeout,d=e.debug,s=e.admin,f=e.firebaseSaveFilter,l=e.firebaseGetFilter,h=e.upload,y=e.save,m=e.del,p=e.getItemID,g=e.getOne,v=e.getMany,w={},E={},b={},A={},O={};o.forEach(function(e,t){"string"==typeof e&&(o[t]=e={name:e,path:e,uploadFields:[]});var r=e.name,n=e.path,a=e.uploadFields;if(!r)throw new Error("name is missing from resource "+e);O[r]=a||[],A[r]=n||r,b[r]={}});var k=function(e,t,r){e.once("value",function(e){if(e.key===t){var n=e.val()||{};Object.keys(n).forEach(function(e){b[t][e]=l(n[e],t)}),Object.keys(b[t]).forEach(function(e){b[t][e].id=e,b[t][e].key=e}),r()}}),e.on("child_added",function(e){b[t][e.key]=l(Object.assign({},{id:e.key,key:e.key},e.val()),t)}),e.on("child_removed",function(e){b[t][e.key]&&delete b[t][e.key]}),e.on("child_changed",function(e){b[t][e.key]=e.val()})};return o.forEach(function(e){w[e.name]=new Promise(function(r){!function(e,r){var n=e.name,a=e.isPublic,i=E[n]=t.database().ref(A[n]);b[n]=[],a?k(i,n,r):t.auth().onAuthStateChanged(function(e){e&&k(i,n,r)}),setTimeout(r,c)}(e,r)})}),function(e,a,i){return new Promise(function(u,o){return d&&console.log(e,a,i),w[a].then(function(c){try{switch(e){case n.GET_LIST:case n.GET_MANY:case n.GET_MANY_REFERENCE:return v(i,a,b[a]).then(function(e){try{return u(e)}catch(e){return o(e)}},o);case n.GET_ONE:return g(i,a,b[a]).then(function(e){try{return u(e)}catch(e){return o(e)}},o);case n.DELETE:return uploadFields=O[a]?O[a]:[],m(i.id,a,A[a],uploadFields).then(function(e){try{return u(e)}catch(e){return o(e)}},o);case n.UPDATE:case n.CREATE:if(shouldCreateUser=s&&s.path===a&&e===n.CREATE&&i.data&&i.data.email&&i.data.password&&s.validate(i.data),!shouldCreateUser)return itemId=p(i,e,a,A[a],b[a]),k.call(this);var l=function(){try{return k.call(this)}catch(e){return o(e)}}.bind(this),w=function(e){try{return u(Promise.reject(new Error(e)))}catch(e){return o(e)}};try{var E;return(E=t.initializeApp(s.config,"user-admin")).auth().createUserWithEmailAndPassword(i.data.email,i.data.password).then(function(e){try{return itemId=e.uid,E.auth().signOut(),l()}catch(e){return w(e)}},w)}catch(e){w(e)}function k(){return uploads=O[a]?O[a].map(function(e){return h(e,i.data,itemId,a,A[a])}):[],currentData=b[a][itemId]||{},Promise.all(uploads).then(function(t){try{return uploadResults=t,y(itemId,i.data,currentData,a,A[a],f,uploadResults,e===n.CREATE,r).then(function(e){try{return u(e)}catch(e){return o(e)}},o)}catch(e){return o(e)}},o)}default:return d&&console.error("Undocumented method: ",e),u({data:[]})}return u()}catch(e){return o(e)}}.bind(this),o)})}},e.methods=i});
//# sourceMappingURL=ra-data-firebase.umd.js.map

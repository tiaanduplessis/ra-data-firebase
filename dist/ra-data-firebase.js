function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("firebase")),r=e(require("sort-by")),n=require("react-admin"),a=e(require("deep-assign")),i={upload:function(e,r,n,a,i){return new Promise(function(a,u){var c,o,d,s;return c=r[e]&&Array.isArray(r[e])?r[e][0]:r[e],o={},c&&c.rawFile&&c.rawFile.name?(d=c.rawFile,t.storage().ref().child(i+"/"+n+"/"+e).put(d).then(function(t){try{if(s=t,o[e]=[{}],o[e][0].uploadedAt=Date.now(),o[e][0].src=s.downloadURL.split("?").shift()+"?alt=media",o[e][0].type=d.type,0===d.type.indexOf("image/")){var r=function(){try{return f.call(this)}catch(e){return u(e)}}.bind(this),n=function(e){try{return console.error("Failed to get image dimensions"),r()}catch(e){return u(e)}};try{var i;return function(e){return new Promise(function(t){var r=document.createElement("img");r.onload=function(){t({width:this.width,height:this.height})},r.src=e.src})}(c).then(function(t){try{return o[e][0].width=(i=t).width,o[e][0].height=i.height,r()}catch(e){return n()}},n)}catch(e){n()}}function f(){return a(o)}return f.call(this)}catch(e){return u(e)}}.bind(this),u)):a(!1)})},save:function(e,r,n,a,i,u,c,o,d){return new Promise(function(a,s){var f,h,l,y;return y=t.auth().currentUser,c&&c.map(function(e){return!!e&&Object.assign(r,e)}),o&&Object.assign(r,((f={})[d.createdAt]=Date.now(),f)),y&&Object.assign(r,((h={})[d.createdBy]=y.uid,h)),(r=Object.assign(n,((l={})[d.updatedAt]=Date.now(),l),r)).key||(r.key=e),r.id||(r.id=e),t.database().ref(i+"/"+r.key).update(u(r)).then(function(e){try{return a({data:r})}catch(e){return s(e)}},s)})},del:function(e,r,n,a){return new Promise(function(r,i){return a.length&&a.map(function(r){return t.storage().ref().child(n+"/"+e+"/"+r).delete()}),t.database().ref(n+"/"+e).remove().then(function(t){try{return r({data:e})}catch(e){return i(e)}},i)})},getItemID:function(e,r,a,i,u){var c=e.data.id||e.id||e.data.key||e.key;if(c||(c=t.database().ref().child(i).push().key),!c)throw new Error("ID is required");if(u&&u[c]&&r===n.CREATE)throw new Error("ID already in use");return c},getOne:function(e,t,r){if(e.id&&r[e.id])return{data:r[e.id]};throw new Error("Key not found")},getMany:function(e,t,n){var a=[],i=[],u=0;if(e.ids&&Array.isArray(e.ids))return e.ids.forEach(function(e){n[e]&&(a.push(e),i.push(n[e]),u++)}),{total:u,ids:a,data:i};if(e.pagination){var c=[],o=Object.assign({},e.filter);e.target&&e.id&&(o[e.target]=e.id);var d=Object.keys(o);d.length?Object.values(n).map(function(e){for(var t=0;t<d.length;){var r=d[t];if("q"!==r&&e[r]!==o[r])return t;if("q"===r&&-1===JSON.stringify(e).indexOf(o.q))return t;t++}return c.push(e),t}):c=Object.values(n),e.sort&&c.sort(r(("ASC"===e.sort.order?"-":"")+e.sort.field));var s=c.map(function(e){return e.id}),f=e.pagination,h=f.page,l=f.perPage,y=(h-1)*l,m=h*l;return i=c.slice(y,m),a=s.slice(y,m),{data:i,ids:a,total:u=c.length}}throw new Error("Error processing request")}},u={initialQuerytimeout:1e4,metaFieldNames:{createdAt:"createdAt",updatedAt:"updatedAt",createdBy:"createdBy"},admin:{path:"users",config:{},validate:function(){return!0}},debug:!1,trackedResources:[],firebaseSaveFilter:function(e){return e},firebaseGetFilter:function(e){return e}};exports.FirebaseDataProvider=function(e){void 0===e&&(e={});var r=(e=a({},u,i,e)).metaFieldNames,c=e.trackedResources,o=e.initialQuerytimeout,d=e.debug,s=e.admin,f=e.firebaseSaveFilter,h=e.firebaseGetFilter,l=e.upload,y=e.save,m=e.del,p=e.getItemID,g=e.getOne,v=e.getMany,E={},w={},b={},A={},k={};c.forEach(function(e,t){"string"==typeof e&&(c[t]=e={name:e,path:e,uploadFields:[]});var r=e.name,n=e.path,a=e.uploadFields;if(!r)throw new Error("name is missing from resource "+e);k[r]=a||[],A[r]=n||r,b[r]={}});var O=function(e,t,r){e.once("value",function(e){if(e.key===t){var n=e.val()||{};Object.keys(n).forEach(function(e){b[t][e]=h(n[e],t)}),Object.keys(b[t]).forEach(function(e){b[t][e].id=e,b[t][e].key=e}),r()}}),e.on("child_added",function(e){b[t][e.key]=h(Object.assign({},{id:e.key,key:e.key},e.val()),t)}),e.on("child_removed",function(e){b[t][e.key]&&delete b[t][e.key]}),e.on("child_changed",function(e){b[t][e.key]=e.val()})};return c.forEach(function(e){E[e.name]=new Promise(function(r){!function(e,r){var n=e.name,a=e.isPublic,i=w[n]=t.database().ref(A[n]);b[n]=[],a?O(i,n,r):t.auth().onAuthStateChanged(function(e){e&&O(i,n,r)}),setTimeout(r,o)}(e,r)})}),function(e,a,i){return new Promise(function(u,c){return d&&console.log(e,a,i),E[a].then(function(o){try{switch(e){case n.GET_LIST:case n.GET_MANY:case n.GET_MANY_REFERENCE:return v(i,a,b[a]).then(function(e){try{return u(e)}catch(e){return c(e)}},c);case n.GET_ONE:return g(i,a,b[a]).then(function(e){try{return u(e)}catch(e){return c(e)}},c);case n.DELETE:return uploadFields=k[a]?k[a]:[],m(i.id,a,A[a],uploadFields).then(function(e){try{return u(e)}catch(e){return c(e)}},c);case n.UPDATE:case n.CREATE:if(shouldCreateUser=s&&s.path===a&&e===n.CREATE&&i.data&&i.data.email&&i.data.password&&s.validate(i.data),!shouldCreateUser)return itemId=p(i,e,a,A[a],b[a]),O.call(this);var h=function(){try{return O.call(this)}catch(e){return c(e)}}.bind(this),E=function(e){try{return u(Promise.reject(new Error(e)))}catch(e){return c(e)}};try{var w;return(w=t.initializeApp(s.config,"user-admin")).auth().createUserWithEmailAndPassword(i.data.email,i.data.password).then(function(e){try{return itemId=e.uid,w.auth().signOut(),h()}catch(e){return E(e)}},E)}catch(e){E(e)}function O(){return uploads=k[a]?k[a].map(function(e){return l(e,i.data,itemId,a,A[a])}):[],currentData=b[a][itemId]||{},Promise.all(uploads).then(function(t){try{return uploadResults=t,y(itemId,i.data,currentData,a,A[a],f,uploadResults,e===n.CREATE,r).then(function(e){try{return u(e)}catch(e){return c(e)}},c)}catch(e){return c(e)}},c)}default:return d&&console.error("Undocumented method: ",e),u({data:[]})}return u()}catch(e){return c(e)}}.bind(this),c)})}},exports.methods=i;
//# sourceMappingURL=ra-data-firebase.js.map

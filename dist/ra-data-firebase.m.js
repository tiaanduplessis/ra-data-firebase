import t from"firebase";import e from"sort-by";import{CREATE as r,GET_LIST as n,GET_ONE as a,GET_MANY as i,GET_MANY_REFERENCE as u,UPDATE as o,DELETE as c}from"react-admin";import d from"deep-assign";var s={upload:function(e,r,n,a,i){return new Promise(function(a,u){var o,c,d,s;return o=r[e]&&Array.isArray(r[e])?r[e][0]:r[e],c={},o&&o.rawFile&&o.rawFile.name?(d=o.rawFile,t.storage().ref().child(i+"/"+n+"/"+e).put(d).then(function(t){try{if(s=t,c[e]=[{}],c[e][0].uploadedAt=Date.now(),c[e][0].src=s.downloadURL.split("?").shift()+"?alt=media",c[e][0].type=d.type,0===d.type.indexOf("image/")){var r=function(){try{return f.call(this)}catch(t){return u(t)}}.bind(this),n=function(t){try{return console.error("Failed to get image dimensions"),r()}catch(t){return u(t)}};try{var i;return function(t){return new Promise(function(e){var r=document.createElement("img");r.onload=function(){e({width:this.width,height:this.height})},r.src=t.src})}(o).then(function(t){try{return c[e][0].width=(i=t).width,c[e][0].height=i.height,r()}catch(t){return n()}},n)}catch(t){n()}}function f(){return a(c)}return f.call(this)}catch(t){return u(t)}}.bind(this),u)):a(!1)})},save:function(e,r,n,a,i,u,o,c,d){return new Promise(function(a,s){var f,h,l,m;return m=t.auth().currentUser,o&&o.map(function(t){return!!t&&Object.assign(r,t)}),c&&Object.assign(r,((f={})[d.createdAt]=Date.now(),f)),m&&Object.assign(r,((h={})[d.createdBy]=m.uid,h)),(r=Object.assign(n,((l={})[d.updatedAt]=Date.now(),l),r)).key||(r.key=e),r.id||(r.id=e),t.database().ref(i+"/"+r.key).update(u(r)).then(function(t){try{return a({data:r})}catch(t){return s(t)}},s)})},del:function(e,r,n,a){return new Promise(function(r,i){return a.length&&a.map(function(r){return t.storage().ref().child(n+"/"+e+"/"+r).delete()}),t.database().ref(n+"/"+e).remove().then(function(t){try{return r({data:e})}catch(t){return i(t)}},i)})},getItemID:function(e,n,a,i,u){var o=e.data.id||e.id||e.data.key||e.key;if(o||(o=t.database().ref().child(i).push().key),!o)throw new Error("ID is required");if(u&&u[o]&&n===r)throw new Error("ID already in use");return o},getOne:function(t,e,r){if(t.id&&r[t.id])return{data:r[t.id]};throw new Error("Key not found")},getMany:function(t,r,n){var a=[],i=[],u=0;if(t.ids&&Array.isArray(t.ids))return t.ids.forEach(function(t){n[t]&&(a.push(t),i.push(n[t]),u++)}),{total:u,ids:a,data:i};if(t.pagination){var o=[],c=Object.assign({},t.filter);t.target&&t.id&&(c[t.target]=t.id);var d=Object.keys(c);d.length?Object.values(n).map(function(t){for(var e=0;e<d.length;){var r=d[e];if("q"!==r&&t[r]!==c[r])return e;if("q"===r&&-1===JSON.stringify(t).indexOf(c.q))return e;e++}return o.push(t),e}):o=Object.values(n),t.sort&&o.sort(e(("ASC"===t.sort.order?"-":"")+t.sort.field));var s=o.map(function(t){return t.id}),f=t.pagination,h=f.page,l=f.perPage,m=(h-1)*l,y=h*l;return i=o.slice(m,y),a=s.slice(m,y),{data:i,ids:a,total:u=o.length}}throw new Error("Error processing request")}},f={initialQuerytimeout:1e4,metaFieldNames:{createdAt:"createdAt",updatedAt:"updatedAt",createdBy:"createdBy"},admin:{path:"users",config:{},validate:function(){return!0}},debug:!1,trackedResources:[],firebaseSaveFilter:function(t){return t},firebaseGetFilter:function(t){return t}};function h(e){void 0===e&&(e={});var h=(e=d({},f,s,e)).metaFieldNames,l=e.trackedResources,m=e.initialQuerytimeout,y=e.debug,p=e.admin,g=e.firebaseSaveFilter,v=e.firebaseGetFilter,w=e.upload,b=e.save,k=e.del,O=e.getItemID,A=e.getOne,F=e.getMany,E={},j={},P={},I={},D={};l.forEach(function(t,e){"string"==typeof t&&(l[e]=t={name:t,path:t,uploadFields:[]});var r=t.name,n=t.path,a=t.uploadFields;if(!r)throw new Error("name is missing from resource "+t);D[r]=a||[],I[r]=n||r,P[r]={}});var U=function(t,e,r){t.once("value",function(t){if(t.key===e){var n=t.val()||{};Object.keys(n).forEach(function(t){P[e][t]=v(n[t],e)}),Object.keys(P[e]).forEach(function(t){P[e][t].id=t,P[e][t].key=t}),r()}}),t.on("child_added",function(t){P[e][t.key]=v(Object.assign({},{id:t.key,key:t.key},t.val()),e)}),t.on("child_removed",function(t){P[e][t.key]&&delete P[e][t.key]}),t.on("child_changed",function(t){P[e][t.key]=t.val()})};return l.forEach(function(e){E[e.name]=new Promise(function(r){!function(e,r){var n=e.name,a=e.isPublic,i=j[n]=t.database().ref(I[n]);P[n]=[],a?U(i,n,r):t.auth().onAuthStateChanged(function(t){t&&U(i,n,r)}),setTimeout(r,m)}(e,r)})}),function(e,d,s){return new Promise(function(f,l){return y&&console.log(e,d,s),E[d].then(function(m){try{switch(null,e){case n:case i:case u:return F(s,d,P[d]).then(function(t){try{return f(t)}catch(t){return l(t)}},l);case a:return A(s,d,P[d]).then(function(t){try{return f(t)}catch(t){return l(t)}},l);case c:return uploadFields=D[d]?D[d]:[],k(s.id,d,I[d],uploadFields).then(function(t){try{return f(t)}catch(t){return l(t)}},l);case o:case r:if(shouldCreateUser=p&&p.path===d&&e===r&&s.data&&s.data.email&&s.data.password&&p.validate(s.data),!shouldCreateUser)return itemId=O(s,e,d,I[d],P[d]),U.call(this);var v=function(){try{return U.call(this)}catch(t){return l(t)}}.bind(this),E=function(t){try{return f(Promise.reject(new Error(t)))}catch(t){return l(t)}};try{var j;return(j=t.initializeApp(p.config,"user-admin")).auth().createUserWithEmailAndPassword(s.data.email,s.data.password).then(function(t){try{return itemId=t.uid,j.auth().signOut(),v()}catch(t){return E(t)}},E)}catch(t){E(t)}function U(){return uploads=D[d]?D[d].map(function(t){return w(t,s.data,itemId,d,I[d])}):[],currentData=P[d][itemId]||{},Promise.all(uploads).then(function(t){try{return uploadResults=t,b(itemId,s.data,currentData,d,I[d],g,uploadResults,e===r,h).then(function(t){try{return f(t)}catch(t){return l(t)}},l)}catch(t){return l(t)}},l)}default:return y&&console.error("Undocumented method: ",e),f({data:[]})}return f()}catch(t){return l(t)}}.bind(this),l)})}}export{h as FirebaseDataProvider,s as methods};
//# sourceMappingURL=ra-data-firebase.m.js.map
